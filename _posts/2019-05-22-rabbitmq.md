---
---
# RabbitMQ

 <br /> <br />**home**<br />[http://www.rabbitmq.com/](http://www.rabbitmq.com/)<br />[https://github.com/rabbitmq/rabbitmq-server](https://github.com/rabbitmq/rabbitmq-server)<br /> <br />**doc:**<br />[http://www.rabbitmq.com/documentation.html](http://www.rabbitmq.com/documentation.html)<br />[http://www.rabbitmq.com/#getstarted](http://www.rabbitmq.com/#getstarted)
(含重要文档入口, 虽名字为getstarted)<br />[https://www.rabbitmq.com/install-debian.html](https://www.rabbitmq.com/install-debian.html)
(含重要内容)<br />manual: [https://www.rabbitmq.com/manpages.html](https://www.rabbitmq.com/manpages.html)<br /> <br />**books:**

| "RabbitMQ实战指南" |   |
| --- | --- |

 <br />**待看<br />[https://www.rabbitmq.com/monitoring.html](https://www.rabbitmq.com/monitoring.html)<br />[https://www.rabbitmq.com/reliability.html](https://www.rabbitmq.com/reliability.html)<br /> <br />**sping rabbitmq concurrency**<br />org.springframework.amqp.rabbit.annotation.RabbitListener

| @RabbitListener#concurrency | 共用一个containerFactory, 此值要在此containerFactory的[concurrency,
  maxConcurrency]之间, 此containerFactory无法精确到一个concurrency值 |
| --- | --- |
| @RabbitListener#containerFactory | 可精确, 不同containerFactory |
|   |   |

 <br />**consumer acknowledgement **<br />[https://www.rabbitmq.com/confirms.html](https://www.rabbitmq.com/confirms.html)<br /> <br /> <br />**Negative Acknowledgement handle**<br />[https://www.rabbitmq.com/confirms.html#consumer-nacks-requeue](https://www.rabbitmq.com/confirms.html#consumer-nacks-requeue)<br />basic.reject | basic.nack<br />由requeue field控制是否requeue<br /> <br />**message without ack  | Consumers Fail or Lose Connection**<br />[https://www.rabbitmq.com/confirms.html#automatic-requeueing](https://www.rabbitmq.com/confirms.html#automatic-requeueing)

| 连接异常或断开; client挂了 | server 自动将其requeue |
| --- | --- |

 <br /> <br />**hearbeat**<br />heartbeantInterval = heartbeatTimeout / 2<br />直接配置的都是heartbeatTimeout <br />[https://www.rabbitmq.com/heartbeats.html](https://www.rabbitmq.com/heartbeats.html)<br />spring-amqp:

| spring.rabbitmq.requested-heartbeat=5s | 实为heartbeat
  timeout, 建议: 5s-20s |
| --- | --- |

rabbit default value:

| heartbeat
  timeout | 60s |
| --- | --- |
| heartbeant
  interval | 30s=60s/2 |

 <br /> <br />**publish return**<br />If the message is also published as mandatory, the
basic.return is sent to the client before basic.ack. The same is true for
negative acknowledgements (basic.nack).<br />[https://www.rabbitmq.com/confirms.html#when-publishes-are-confirmed](https://www.rabbitmq.com/confirms.html#when-publishes-are-confirmed)<br /> <br /> <br /> <br />**publish

| exchange | binding | queue | ae | length
  limit | 结果 | publisher
  confirm(ack/nack) |
| --- | --- | --- | --- | --- | --- | --- |
| 有 | 无 |  --- | 有 |   | 转发给了ae (为ae的职责,前提是有exchange) | ack |
| 无 | --- | --- | --- |   | error,执行若有的FailureCallback, <br />
  channel shutdown (与ae无关) | --- |
| 有 | 有 | 有 | --- | 达到limit |   | nack |

 <br /> <br />**QoS**<br />100-300<br />[https://www.rabbitmq.com/confirms.html#channel-qos-prefetch-throughput](https://www.rabbitmq.com/confirms.html#channel-qos-prefetch-throughput)<br />Values in the 100 through 300 range usually offer optimal
throughput and do not run significant risk of overwhelming consumers. Higher
values often run into the law of diminishing returns.<br /> <br />**TTL**<br />[https://www.rabbitmq.com/ttl.html](https://www.rabbitmq.com/ttl.html)<br />message TTL: Only when expired messages reach the head of
a queue will they actually be discarded (or dead-lettered)<br />queue TTL: 只保证指定时间后, 不保证准时<br /> <br />**integrated policy**

| PL-HA-DLX-AE | sudo
  rabbitmqctl set_policy   PL-HA-DLX-AE
  ".*" '{ "ha-mode":"exactly",   "ha-params":2,
  "queue-master-locator":"min-masters",
  "ha-sync-batch-size":100
  ,"ha-sync-mode":"manual"
  ,"ha-promote-on-failure":"always"
  ,"ha-promote-on-shutdown":"when-synced","dead-letter-exchange":"EX-dlx","dead-letter-routing-key":"dlx.all","alternate-exchange":"EX-ae"
  }' -p vh_photo |
| --- | --- |

 <br />**Alternate Exchanges**

| 全局设置 | sudo
  rabbitmqctl  set_policy PL-AE
  ".*" '{"alternate-exchange":"EX-ae"}'
  --apply-to exchanges  -p vh_social<br />
   <br />#create an
  exchange:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/exchanges/vh_social/EX-ae](http://localhost:15672/api/exchanges/vh_social/EX-ae)'
  -X PUT -d
  '{"type":"fanout","auto_delete":false,"durable":true,"internal":false,"arguments":{}}'<br /> <br />#create a
  queue:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/queues/vh_social/Q-ae-letter](http://localhost:15672/api/queues/vh_social/Q-ae-letter)'
  -X PUT -d
  '{"auto_delete":false,"durable":true,"arguments":{}}'<br /> <br />#create a
  binding:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/bindings/vh_social/e/EX-ae/q/Q-ae-letter](http://localhost:15672/api/bindings/vh_social/e/EX-ae/q/Q-ae-letter)'
  -X POST -d '{"routing_key":"ae.all"}'<br /> <br />#check a
  binding:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/bindings/vh_social/e/EX-ae/q/Q-ae-letter](http://localhost:15672/api/bindings/vh_social/e/EX-ae/q/Q-ae-letter)' |   |
| --- | --- | --- |
| 建议 | EX-my-ae建议设置为fanout |   |
| 特点 | a message is considered as being routed successful when
  routed to EX-my-ae<br />
  exchange args覆盖全局配置 |   |

 <br />**dead-lettering / 死信机制 / <br />[https://www.rabbitmq.com/dlx.html](https://www.rabbitmq.com/dlx.html)

| 全局配置 | #add
  policy:<br />sudo
  rabbitmqctl set_policy PL-DLX ".*"
  '{"dead-letter-exchange":"EX-dlx","dead-letter-routing-key":"dlx.all"}'
  --apply-to all -p vh_photo<br /> <br />#create an
  exchange:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/exchanges/vh_photo/EX-dlx](http://localhost:15672/api/exchanges/vh_photo/EX-dlx)'
  -X PUT -d
  '{"type":"direct","auto_delete":false,"durable":true,"internal":false,"arguments":{}}'<br /> <br />#create a
  queue:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/queues/vh_photo/Q-dead-letter](http://localhost:15672/api/queues/vh_photo/Q-dead-letter)'
  -X PUT -d '{"auto_delete":false,"durable":true,"arguments":{}}'<br /> <br />#create a
  binding:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/bindings/vh_photo/e/EX-dlx/q/Q-dead-letter](http://localhost:15672/api/bindings/vh_photo/e/EX-dlx/q/Q-dead-letter)'
  -X POST -d '{"routing_key":"dlx.all"}'<br /> <br />#check a
  binding:<br />curl -u
  admin:admin123 '[http://localhost:15672/api/bindings/vh_photo/e/EX-dlx/q/Q-dead-letter](http://localhost:15672/api/bindings/vh_photo/e/EX-dlx/q/Q-dead-letter)' |
| --- | --- |
| 建议 | EX-dlx设置为direct类型 |
| queue
  arguments配置 |        
  arguments.put("x-dead-letter-exchange", "EX-dlx");<br />       
  arguments.put("x-dead-letter-routing-key",
  DEAD_LETTER_ROUTING_KEY); |
| 特点 | 循环则被drop; <br />queue
  arguments 覆盖policy<br />
  每个dead letter的内容会被处理, 如新增x-death数组以记录本letter的dead-lettering特征； |
| dead letter cause | ·       
  rejected with no requeue: basic.reject  with no requeue || basic.nack with no
  requeue<br />·       
  TTL<br />·       
  queue length limit |

** **<br />**requeue  / redeliver / 


| demo |     private AtomicInteger redeliveryCount =
  new AtomicInteger(0);<br /> <br />    @RabbitListener(queues =
  "Q-helloDirect1")<br />    public void consume1(String payload,
  Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) throws
  IOException {<br />        try {<br />           
  System.out.println("+++++++++received msg1: '" + payload +
  "'");<br />            channel.basicAck(deliveryTag,
  false);<br />        } catch (IOException e) {<br />            e.printStackTrace();<br />            if
  (redeliveryCount.getAndIncrement() < 3) {//requeued; counter to avoid dead
  cycle<br />                channel.basicReject(deliveryTag,
  true);<br />                //or<br />//           
  channel.basicNack(deliveryTag,false,true);<br />            } else {//discarded/dead-lettered<br />               
  channel.basicReject(deliveryTag, false);<br />//or<br />//               
  channel.basicNack(deliveryTag,false,false);<br />                redeliveryCount.set(0);<br />            }<br />        }<br />    } |
| --- | --- |
| 注意 | 需要避免死循环, 如增加计数器 |

 <br /> <br /> <br />**message trace**<br />[https://www.rabbitmq.com/firehose.html](https://www.rabbitmq.com/firehose.html)

| sudo
  rabbitmq-plugins enable rabbitmq_tracing |   |
| --- | --- |
| sudo
  rabbitmqctl trace_on -p vh_social |   |
| 创建queue绑定到exchange: amq.rabbitmq.trace |   |

关闭trace:  

| sudo
  rabbitmqctl trace_off -p vh_social |   |
| --- | --- |

 <br />**特性**<br />publisher confirm: <br />ack无序, 异步, 延时长短取决于消息类型和queue类型<br />若是mirror queue, 则在mirror完之后broker给ack<br />若是durable queue, 则在写入磁盘后broker给ack. 其中, 写磁盘按批处理, 几百毫秒一次, 因此ack有延时<br />用户可以设置多个vhost<br />一个消息在一个队列只存在一个<br />Direct Exchange消息只存在一份, 即使有多个Queue 绑定它<br />一个exchange或queue上只能存在一个policy, 新来的覆盖旧的<br /> <br /> <br />**configuration**<br />rabbitmq.conf<br />[http://www.rabbitmq.com/configure.html](http://www.rabbitmq.com/configure.html)<br />rabbitmq.conf
example:<br />[https://github.com/rabbitmq/rabbitmq-server/blob/master/docs/rabbitmq.conf.example](https://github.com/rabbitmq/rabbitmq-server/blob/master/docs/rabbitmq.conf.example)<br />advanced.config example:<br />[https://github.com/rabbitmq/rabbitmq-server/blob/master/docs/advanced.config.example](https://github.com/rabbitmq/rabbitmq-server/blob/master/docs/advanced.config.example)<br />Core Server Variables Configurable in rabbitmq.conf:<br />[http://www.rabbitmq.com/configure.html#config-items](http://www.rabbitmq.com/configure.html#config-items)<br />大部分配置变更后需要重启服务 

| sudo service rabbitmq-server
  restart |   |
| --- | --- |

** **<br />**extenstion**<br />[http://www.rabbitmq.com/extensions.html](http://www.rabbitmq.com/extensions.html)<br />** **<br />**concepts**<br />[http://www.rabbitmq.com/tutorials/amqp-concepts.html](http://www.rabbitmq.com/tutorials/amqp-concepts.html)

| authentication
   |  "identifying who the user is"  | 鉴定 |
| --- | --- | --- |
| authorisation
   |  "determining what the user is and isn't
  allowed to do." | 决定 |

** **<br />**amqp-0-9-1**<br />rabbitmq对它的快速介绍: [https://www.rabbitmq.com/amqp-0-9-1-quickref.html](https://www.rabbitmq.com/amqp-0-9-1-quickref.html)<br />[http://www.rabbitmq.com/amqp-0-9-1-reference.html](http://www.rabbitmq.com/amqp-0-9-1-reference.html)<br />官文: [https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf](https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf)<br />rabbitmq对amqp的支持特点: [https://www.rabbitmq.com/specification.html](https://www.rabbitmq.com/specification.html)<br /> <br />最佳实践<br />[https://www.cloudamqp.com/blog/2017-12-29-part1-rabbitmq-best-practice.html](https://www.cloudamqp.com/blog/2017-12-29-part1-rabbitmq-best-practice.html)<br /> <br />**spring amqp sample**<br />[https://github.com/spring-projects/spring-amqp-samples](https://github.com/spring-projects/spring-amqp-samples)<br /><rabbit:connection-factory<br />   
id="connectionFactory" addresses="host1:5672,host2:5672"/><br /> <br /> <br />**high
availability / <br />optimize:

| sudo
  rabbitmqctl set_policy   PL-HA
  ".*" '{ "ha-mode":"exactly",   "ha-params":2,
  "queue-master-locator":"min-masters",
  "ha-sync-batch-size":100 ,"ha-sync-mode":"manual"
  ,"ha-promote-on-failure":"always"
  ,"ha-promote-on-shutdown":"when-synced" }' -p
  "vh_social" | policy<br />
  注: -p参数按需要填vhost |
| --- | --- |
| #values:
  ignore(default), pause_minority,pause_if_all_down,autoheal <br />
  cluster_partition_handling = ignore  | configs |

[https://www.rabbitmq.com/ha.html](https://www.rabbitmq.com/ha.html)<br />policy
key:

| ha-mode | ha-params | example |
| --- | --- | --- |
| exactly(建议) | <count> | rabbitmqctl
  set_policy ha-two "^two\." \<br />  
  '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}' |
| all | --- | rabbitmqctl
  set_policy ha-all "^ha\." '{"ha-mode":"all"}' |
| nodes | <node
  list> | rabbitmqctl
  set_policy ha-nodes "^nodes\." \<br />  
  '{"ha-mode":"nodes","ha-params":["rabbit@nodeA",
  "rabbit@nodeB"]}' |

 <br />three
ways key:

| queue_master_locator | the config
  key |
| --- | --- |
| queue-master-locator | the policy
  key |
| x-queue-master-locator | the queue
  declare argument |

 <br /> 

| queue
  mirroring | All operations for a given queue
  are first applied on the queue's master node and then propagated to mirrors.<br />when a message is acknowledged at
  the master, the mirror queues drop it.<br />does not distribute load across
  nodes.<br />
  <br />
  do not support exclusive queues<br />
  <br />
  方式一:<br />rabbitmqctl set_policy ha-two
  "^two\." \<br />  
  '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'<br />
  方式二:<br />
  HTTP API:<br />PUT /api/policies/%2f/ha-two<br />{"pattern":"^two\.",
  "definition":{"ha-mode":"exactly",
  "ha-params":2,"ha-sync-mode":"automatic"}}<br /> <br />方式三:<br />
  web ui |   |
| --- | --- | --- |
| Queue
  Master Location |  <br />values:<br />min-masters
  (建议),client-local
  (default),random<br />
    |   |
| promotion | Promotion of Unsynchronised Mirrors
  on Failure=>
  ha-promote-on-failure : always (default, 建议), when-synced<br />ha-promote-on-shutdown :  when-synced (default, 建议) , always | promotion: a mirror be promoted to a master<br />
  默认即可<br />
    |
| sync | ha-sync-batch-size<br />
  ha-sync-mode : manual(default, 建议) , automatic | block when
  in sync |
| [partition](https://www.rabbitmq.com/partitions.html) | #values: ignore(default),
  pause_minority,pause_if_all_down,autoheal <br />
  cluster_partition_handling = ignore  |   |

 <br /> <br />**优化**<br />I/O:<br />[https://www.rabbitmq.com/persistence-conf.html](https://www.rabbitmq.com/persistence-conf.html)<br />瓶颈 => Too few file handles, Too
few async threads<br />[http://erlang.org/doc/man/erl.html#async_thread_pool_size](http://erlang.org/doc/man/erl.html#async_thread_pool_size)<br /> <br /> <br />**policy**<br />特点： 相同priority下时间新的优先，
一个entity只能应用一个, entity上所应用的policy可实时改变

| set_policy
  [-p vhost] [--priority priority] [--apply-to apply-to] name pattern
  definition | name自定义
  value 为JSON |
| --- | --- |

[https://www.rabbitmq.com/parameters.html#policies](https://www.rabbitmq.com/parameters.html#policies)<br />Each
exchange or queue will have at most one policy matching, 可以combine,
see [Combining Policy Definitions ](https://www.rabbitmq.com/parameters.html#combining-policy-definitions)<br />Policies
can be used to configure the [federation plugin](https://www.rabbitmq.com/federation.html), [mirrored queues](https://www.rabbitmq.com/ha.html), [alternate exchanges](https://www.rabbitmq.com/ae.html),[dead lettering](https://www.rabbitmq.com/dlx.html), [per-queue TTLs](https://www.rabbitmq.com/ttl.html), and [maximum queue length](https://www.rabbitmq.com/maxlength.html).

| rabbitmqctl
  set_policy federate-me "^amq\."
  '{"federation-upstream-set":"all"}' --priority 1
  --apply-to exchanges |   |
| --- | --- |
| PUT
  /api/policies/%2f/federate-me<br />                    {"pattern":
  "^amq\.",<br />                     "definition":
  {"federation-upstream-set":"all"},<br />                     "priority": 1,<br />                    "apply-to":
  "exchanges"} | HTTP API |
| web ui |   |

An
operator policy Conflict Resolution with Regular Policies:<br />the
smaller value is chosen as effective<br />operator
policies, don't just overwrite regular policy values. They enforce limits but
try to not override user-provided policies where possible.<br /> <br />**health check**<br />amqp/web http都使用TCP 路由模式, 对5672/15672进行端口健康检查<br />默认heartbeat
timeout 60s, heartbeta interval is half of it that is 30s<br />[https://www.rabbitmq.com/management.html#http-api](https://www.rabbitmq.com/management.html#http-api)<br />[https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/api/index.html](https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/api/index.html)

| TCP 端口健康检查 | amqp/web
  http都使用TCP 路由模式 |
| --- | --- |
| /api/healthchecks/node<br />
  i.e.<br />
  curl -i -u guest:guest [http://localhost:15672/api/healthchecks/node](http://localhost:15672/api/healthchecks/node) |   |
| /api/aliveness-test/<vhost><br />
  i.e.<br />
  curl -i [http://guest:guest@localhost:15672/api/aliveness-test/%2F](http://guest:guest@localhost:15672/api/aliveness-test/%2F) | "%2F"指vhost
  "/" |

 <br /> <br />**partitions**<br />[https://www.rabbitmq.com/partitions.html](https://www.rabbitmq.com/partitions.html)

| sudo rabbitmqctl
  cluster_status | {partitions,[]}<br />
  {partitions,[{rabbit@smacmullen,[hare@smacmullen]} |
| --- | --- |
| curl -i -u
  guest:guest [http://localhost:15672/api/nodes](http://localhost:15672/api/nodes) | under
  "partitions"  |

Partition Handling Strategies:<br />[https://www.rabbitmq.com/partitions.html#automatic-handling](https://www.rabbitmq.com/partitions.html#automatic-handling)

| ingore | default, 内网建议用它
  CAP: consistency (low),  partition
  tolerance (high),  availability (high) |
| --- | --- |
| pause_minority | minority: fewer or equal than half the total
  number of nodes<br />
  对 suspended导致的Split-Brain无用<br />
  当两个partition的成员数相等时, 两个都会pause and rejoin
  CAP: consistency (high), partition tolerance (high),  availability (middle) |
| pause_if_all_down | CAP: consistency (low),  partition tolerance (high),  availability (high) |
| autoheal | CAP: consistency (low),  partition tolerance (high),  availability (high) |
| 配置示例 | 
  # default to ignore<br />
  cluster_partition_handling = pause_if_all_down<br />
   <br />## Recovery
  strategy only for
  pause_if_all_down, Can be either 'autoheal' or 'ignore'<br />cluster_partition_handling.pause_if_all_down.recover
  = ignore<br /> <br />## nodes
  which should be unavailable to pause；保留两个作例外, 否则可能全挂<br />cluster_partition_handling.pause_if_all_down.nodes.1
  = rabbit@myhost1<br />cluster_partition_handling.pause_if_all_down.nodes.2
  = rabbit@myhost2 |

CAP theorem:<br />[https://en.wikipedia.org/wiki/CAP_theorem](https://en.wikipedia.org/wiki/CAP_theorem)<br />·       
[_Consistency_](https://en.wikipedia.org/wiki/Consistency_(database_systems)):
Every read receives the most recent write or an error<br />·       
[_Availability_](https://en.wikipedia.org/wiki/Availability):
Every request receives a (non-error) response – without the guarantee
that it contains the most recent write<br />·       
[_Partition
tolerance_](https://en.wikipedia.org/wiki/Network_partitioning): The system continues to operate despite an
arbitrary number of messages being dropped (or delayed) by the network between
nodes<br /> <br /> <br />**HTTP API**<br />[https://www.rabbitmq.com/management.html#http-api](https://www.rabbitmq.com/management.html#http-api)<br />[https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/api/index.html](https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/api/index.html)<br />[https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/doc/stats.html](https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.12/priv/www/doc/stats.html)<br />endpoint: [http://server-name:15672/api](http://server-name:15672/api)<br />i.e. [http://dev.ufotosoft.com:15672/api](http://dev.ufotosoft.com:15672/api)

| curl -i -u
  guest:guest [http://localhost:15672/api/vhosts](http://localhost:15672/api/vhosts) |   |
| --- | --- |

 <br />rabbitmqadmin (based on HTTP API):<br />[https://www.rabbitmq.com/management-cli.html](https://www.rabbitmq.com/management-cli.html)<br />[https://www.rabbitmq.com/management.html#http-api-clients](https://www.rabbitmq.com/management.html#http-api-clients)<br />source
code: [https://raw.githubusercontent.com/rabbitmq/rabbitmq-management/v3.7.12/bin/rabbitmqadmin](https://raw.githubusercontent.com/rabbitmq/rabbitmq-management/v3.7.12/bin/rabbitmqadmin)<br />obtaining:
[http://{hostname}:15672/cli](http://%7bhostname%7d:15672/cli)<br />i.e. [http://dev.ufotosoft.com:15672/cli](http://dev.ufotosoft.com:15672/cli)

| rabbitmqadmin
  list exchanges |   |
| --- | --- |

 <br />**CLI:**<br />[http://www.rabbitmq.com/cli.html](http://www.rabbitmq.com/cli.html)<br />[http://www.rabbitmq.com/management.html](http://www.rabbitmq.com/management.html)<br />[http://www.rabbitmq.com/management-cli.html](http://www.rabbitmq.com/management-cli.html)<br />[http://www.rabbitmq.com/networking.html](http://www.rabbitmq.com/networking.html)<br />[http://www.rabbitmq.com/devtools.html#devops-tools](http://www.rabbitmq.com/devtools.html#devops-tools)<br />[http://www.rabbitmq.com/install-debian.html#managing-service](http://www.rabbitmq.com/install-debian.html#managing-service)
<br />rabbitmqctl:<br />[https://www.rabbitmq.com/rabbitmqctl.8.html](https://www.rabbitmq.com/rabbitmqctl.8.html)

| rabbitmqctl
  delete_user janeway | 删除用户 |
| --- | --- |
| rabbitmqctl
  change_password janeway newpass | 变更密码 |

cli:
<br />man <cli><br /><cli>
--help

| rabbitmqctl | [https://www.rabbitmq.com/rabbitmqctl.8.html](https://www.rabbitmq.com/rabbitmqctl.8.html) |
| --- | --- |
| rabbitmq-diagnostics | [https://www.rabbitmq.com/rabbitmq-diagnostics.8.html](https://www.rabbitmq.com/rabbitmq-diagnostics.8.html) |
| rabbitmq-plugins | [https://www.rabbitmq.com/rabbitmq-plugins.8.html](https://www.rabbitmq.com/rabbitmq-plugins.8.html) |

 <br />**access control**<br />[http://www.rabbitmq.com/authentication.html](http://www.rabbitmq.com/authentication.html)<br />[https://www.rabbitmq.com/access-control.html](https://www.rabbitmq.com/access-control.html)<br />[https://www.rabbitmq.com/management.html#permissions](https://www.rabbitmq.com/management.html#permissions)<br /> <br /> <br />**web / management**<br />[https://www.rabbitmq.com/management.html](https://www.rabbitmq.com/management.html)<br />[https://www.rabbitmq.com/admin-guide.html](https://www.rabbitmq.com/admin-guide.html)

| sudo rabbitmq-plugins enable
  rabbitmq_management |   |
| --- | --- |
| # 不建议. support
  remote access by guest / guest <br />
  sudo echo "loopback_users = none" | sudo tee
  /etc/rabbitmq/rabbitmq.conf<br />
  <br />
  # 取消: 显式设置为默认. vim /etc/rabbitmq/rabbitmq.conf<br />loopback_users.guest = true | 不建议. 建议新建admin web用户 |
| [http://localhost:15672](http://localhost:15672)   guest / guest <br />
  [http://dev.ufotosoft.com:15672](http://dev.ufotosoft.com:15672) | guest /
  guest 为default,
  only for localhost connection, <br />除非配置:
  loopback_users = none |
| sudo rabbitmqctl add_user admin
  admin123 <br />sudo rabbitmqctl set_permissions -p
  / admin ".*" ".*" ".*"<br />sudo rabbitmqctl set_user_tags
  admin administrator | 新建admin web用户 |

HTTP API: [http://dev.ufotosoft.com:15672/api](http://dev.ufotosoft.com:15672/api)<br />CMD API: rabbitmqadmin witten in python, download=>  [https://www.rabbitmq.com/management-cli.html](https://www.rabbitmq.com/management-cli.html)<br />doc=> [https://www.rabbitmq.com/management-cli.html](https://www.rabbitmq.com/management-cli.html)<br />source code=>https://raw.githubusercontent.com/rabbitmq/rabbitmq-management/v3.7.12/bin/rabbitmqadmin<br />setup=>

| ##setup-rabbitmqadmin.sh<br />wget [http://localhost:15672/cli/rabbitmqadmin](http://localhost:15672/cli/rabbitmqadmin)<br />sudo mv
  rabbitmqadmin /usr/local/bin<br />sudo chown
  root:root /usr/local/bin/rabbitmqadmin<br />sudo chmod
  775 /usr/local/bin/rabbitmqadmin<br />ls -l
  /usr/local/bin/rabbitmqadmin<br />rabbitmqadmin
  --help<br />sudo sh -c
  'rabbitmqadmin --bash-completion > /etc/bash_completion.d/rabbitmqadmin' | 若报"/usr/bin/env:
  ‘python’: No such file or directory", 则若安装了python3,则<br />whereis
  python<br />which python3
  sudo ln -s /usr/bin/python3 /usr/bin/python |
| --- | --- |

access controll:<br />[https://www.rabbitmq.com/management.html#permissions](https://www.rabbitmq.com/management.html#permissions)<br />[http://www.rabbitmq.com/access-control.html](http://www.rabbitmq.com/access-control.html)<br />management
UI access is controlled by user tags.

| **Tag** | **Capabilities** |
| --- | --- |
| (None) | No
  access to the management plugin |
| management | Anything the user could do via messaging protocols
  plus:<br />·       
  List virtual hosts to which they can log in via AMQP<br />·       
  View all queues, exchanges and bindings in
  "their" virtual hosts<br />·       
  View and close their own channels and connections<br />·       
  View "global" statistics covering all
  their virtual hosts, including activity by other users within them |
| policymaker | Everything "management" can plus:<br />·       
  View, create and delete policies and parameters for
  virtual hosts to which they can log in via AMQP |
| monitoring | Everything "management" can plus:<br />·       
  List all virtual hosts, including ones they could
  not access using messaging protocols<br />·       
  View other users's connections and channels<br />·       
  View node-level data such as memory use and
  clustering<br />·       
  View truly global statistics for all virtual hosts |
| administrator | Everything "policymaker" and
  "monitoring" can plus:<br />·       
  Create and delete virtual hosts<br />·       
  View, create and delete users<br />·       
  View, create and delete permissions<br />·       
  Close other users's connections |

重置stats 数据(其存于内存): [https://www.rabbitmq.com/management.html#stats-db](https://www.rabbitmq.com/management.html#stats-db)

| rabbitmqctl eval
  'rabbit_mgmt_storage:reset().' |   |
| --- | --- |
| rabbitmqctl eval
  'rabbit_mgmt_storage:reset_all().' |   |
| DELETE /api/reset | all node |
| DELETE /api/reset/:node |   |
| web ui上的button |   |

动态修改配置:

| rabbitmqctl
  eval 'application:set_env(rabbit, collect_statistics_interval, 60000).' | collect_statistics_interval |
| --- | --- |

 <br />**cluster:**<br />[http://www.rabbitmq.com/clustering.html](http://www.rabbitmq.com/clustering.html)<br />[https://www.rabbitmq.com/cluster-formation.html](https://www.rabbitmq.com/cluster-formation.html)
<br />除了queue不会自动同步外, 其他都会.<br />推荐使用consul做服务注册中心<br />高可用: [https://www.rabbitmq.com/ha.html](https://www.rabbitmq.com/ha.html)<br />经典问题: [https://www.rabbitmq.com/ha.html#non-mirrored-queue-behavior-on-node-failure](https://www.rabbitmq.com/ha.html#non-mirrored-queue-behavior-on-node-failure)<br />有数据的节点加群: [https://www.rabbitmq.com/blue-green-upgrade.html](https://www.rabbitmq.com/blue-green-upgrade.html)<br />[https://www.rabbitmq.com/backup.html](https://www.rabbitmq.com/backup.html)<br />partition: [https://www.rabbitmq.com/partitions.html](https://www.rabbitmq.com/partitions.html)<br />注意事项:<br />prod下, 任何时候至少要存活一个节点, 特别是使用会回收机器的autoscaling场景<br />为了admin web收集到metrics, cluster中每个node至少开启 rabbitmq-management-agent或rabbitmq_management,建议后者

| sudo rabbitmq-plugins enable rabbitmq_management | install脚本中已开启它 |
| --- | --- |
| sudo rabbitmq-plugins enable  rabbitmq-management-agent |   |

[https://www.rabbitmq.com/management.html#clustering-subset-of-nodes](https://www.rabbitmq.com/management.html#clustering-subset-of-nodes)<br /> <br />client不会重定向到master node, 而是由cluster route operations to
the master node, 来实现operations always operated on a
master node<br />_If
master node of a queueis available, all queue operations (e.g. declaration,
binding and consumer management, message routing to the queue) can be performed
on any node. Cluster nodes will route operations to the master node
transparently to the clients._<br /> <br />**不易找**<br />Negative
Acknowledgements:<br />[https://www.rabbitmq.com/nack.html](https://www.rabbitmq.com/nack.html)<br />Publisher Confirms:<br />[https://www.rabbitmq.com/confirms.html](https://www.rabbitmq.com/confirms.html)<br /> <br />**file location: **<br />**启动日志查看运行时文件位置

| /var/log/rabbitmq/rabbit@<hostname>.log |   |
| --- | --- |

example:<br />node           :
rabbit@example<br />home dir       :
/var/lib/rabbitmq<br />config file(s) : /etc/rabbitmq/advanced.config<br />               :
/etc/rabbitmq/rabbitmq.conf<br /> 

| sudo
  journalctl -u rabbitmq-server.service | less |   |
| --- | --- |

 <br /> <br />**命令查看运行时文件位置

| sudo rabbitmqctl
  environment  |   |
| --- | --- |

也可通过web admin查看:<br />[http://dev.ufotosoft.com:15672](http://dev.ufotosoft.com:15672)   guest / guest<br /> <br /> <br />**默认配置的文件位置<br />[http://www.rabbitmq.com/configure.html#config-location](http://www.rabbitmq.com/configure.html#config-location)<br />[http://www.rabbitmq.com/relocate.html](http://www.rabbitmq.com/relocate.html)


| log dir | /var/log/rabbitmq |
| --- | --- |
| config dir | /etc/rabbitmq |
| config file | /etc/rabbitmq/rabbitmq.conf  (sysctl format, as is key-value
  format, new)<br />
  /etc/rabbitmq/advanced.config  (erlang
  format)<br />
  /etc/rabbitmq/rabbitmq-env.conf  (环境变量)<br />
  两种格式 : sysctl format (new, extension: conf), erlang format(old,
  extension: config) |
| node  | rabbit@<hostname> |
| database
  dir | /var/lib/rabbitmq/mnesia |
| logic home | /usr/lib/rabbitmq |
| real home | /usr/lib/rabbitmq/lib/rabbitmq_server-3.7.11 |
| pid | sudo cat /var/lib/rabbitmq/mnesia/rabbit@<hostname>.pid |
| plugins dir | ${real home}/plugins |

 <br />**production checklist**<br />[http://www.rabbitmq.com/production-checklist.html](http://www.rabbitmq.com/production-checklist.html)<br />[https://www.rabbitmq.com/backup.html](https://www.rabbitmq.com/backup.html)<br />[https://www.rabbitmq.com/reliability.html](https://www.rabbitmq.com/reliability.html)<br /> <br /> <br />**Community Plugins**<br />[http://www.rabbitmq.com/download.html#community-plugins](http://www.rabbitmq.com/download.html#community-plugins)<br /> <br />**Log Files and Management**<br />[http://www.rabbitmq.com/install-debian.html#server-logs](http://www.rabbitmq.com/install-debian.html#server-logs)

| /var/log/rabbitmq | 日志位置 |
| --- | --- |
| sudo
  journalctl --system | grep rabbitmq | 或 |

[http://www.rabbitmq.com/logging.html](http://www.rabbitmq.com/logging.html)<br />[http://www.rabbitmq.com/relocate.html](http://www.rabbitmq.com/relocate.html)<br />日志滚动配置位置:

| /etc/logrotate.d/rabbitmq-server |   |
| --- | --- |

 <br /> <br />**应用级命令<br />[http://www.rabbitmq.com/cli.html](http://www.rabbitmq.com/cli.html)<br />command list:

| [rabbitmqctl](http://www.rabbitmq.com/rabbitmqctl.8.html)  | for service
  management and general operator tasks |
| --- | --- |
| rabbitmq-diagnostics  | for
  diagnostics and [health checking](http://www.rabbitmq.com/monitoring.html) |
| [rabbitmq-plugins](http://www.rabbitmq.com/rabbitmq-plugins.8.html)  | for [plugin management](http://www.rabbitmq.com/plugins.html) |
| [rabbitmqadmin](http://www.rabbitmq.com/management-cli.html)  | for
  operator tasks over [HTTP API](http://www.rabbitmq.com/management.html) |

command use example:

| sudo
  rabbitmq-diagnostics status |   |
| --- | --- |
| sudo rabbitmq-diagnostics
  environment |   |
| sudo
  rabbitmq-diagnostics node_health_check |   |
| rabbitmqctl
  eval “node().” | 查看node name |

 <br />**服务命令<br />man service

| sudo
  service rabbitmq-server stop | 或sudo systemctl
  stop rabbitmq-server  |
| --- | --- |
| sudo
  service rabbitmq-server start | 或sudo systemctl
  start rabbitmq-server  |
| sudo
  service rabbitmq-server status | 或sudo systemctl
  status rabbitmq-server  |

** **<br />**vhost**<br />[https://www.rabbitmq.com/vhosts.html](https://www.rabbitmq.com/vhosts.html)

| sudo rabbitmqctl
  add_vhost qa1 | add |
| --- | --- |
| curl -u
  userename:pa$sw0rD -X PUT [http://rabbitmq.local:15672/api/vhosts/vh1](http://rabbitmq.local:15672/api/vhosts/vh1) | add |
| sudo  rabbitmqctl delete_vhost qa1 | delete |
| curl -u
  userename:pa$sw0rD -X DELETE [http://rabbitmq.local:15672/api/vhosts/vh1](http://rabbitmq.local:15672/api/vhosts/vh1) | delete |
| rabbitmqctl
  set_vhost_limits -p vhost_name '{"max-connections": 256}'<br />rabbitmqctl
  set_vhost_limits -p vhost_name '{"max-queues": 1024}' | config
  limit. 0: disable the function; -1: unlimited |

api example:<br />[https://www.rabbitmq.com/api-guide.html](https://www.rabbitmq.com/api-guide.html)

| ConnectionFactory
  factory = new ConnectionFactory();<br />//
  "guest"/"guest" by default, limited to localhost
  connections<br />factory.setUsername(userName);<br />factory.setPassword(password);<br />factory.setVirtualHost(virtualHost);<br />factory.setHost(hostName);<br />factory.setPort(portNumber);<br /> <br />Connection
  conn = factory.newConnection(); |   |
| --- | --- |
| ConnectionFactory
  factory = new ConnectionFactory();<br />factory.setUri("amqp://userName:password@hostName:portNumber/virtualHost");<br />Connection
  conn = factory.newConnection(); | 或 |

** **<br />**setup cluster manually :**

| ##join-rabbitmq-cluster-manually.sh<br />sudo
  rabbitmqctl  stop_app<br /># unify the
  cookie<br />sudo echo
  "IBRKABSEAWMHOBQXZXKO" |sudo tee /var/lib/rabbitmq/.erlang.cookie<br /># reset<br />sudo
  rabbitmqctl reset<br />sudo
  rabbitmqctl join_cluster rabbit@ip-172-31-69-181<br />sudo
  rabbitmqctl start_app<br />
  <br />
  # verify<br />sudo
  rabbitmq-diagnostics discover_peers --timeout 60<br />sudo
  rabbitmqctl cluster_status | 其中,
  IBRKABSEAWMHOBQXZXKO取自rabbit@ip-172-31-69-181的/var/lib/rabbitmq/.erlang.cookie |
| --- | --- |

 <br />**setup Config File Peer Discovery
Backend**<br />[https://www.rabbitmq.com/cluster-formation.html#peer-discovery-classic-config](https://www.rabbitmq.com/cluster-formation.html#peer-discovery-classic-config)

| ##setup-rabbitmq-configfile-discovery.sh<br />cat
  <<EOF | sudo tee /etc/rabbitmq/rabbitmq.conf<br />cluster_formation.peer_discovery_backend
  = rabbit_peer_discovery_classic_config<br />cluster_formation.classic_config.nodes.1
  = rabbit@ip-172-31-69-181<br />cluster_formation.classic_config.nodes.2
  = rabbit@ip-172-31-19-53<br />cluster_formation.classic_config.nodes.3
  = rabbit@ip-172-31-23-181<br />EOF<br /> <br />sudo
  systemctl restart rabbitmq-server.service<br />sudo
  rabbitmq-diagnostics discover_peers<br />sudo
  rabbitmqctl cluster_status |   |
| --- | --- |
| ##clear-rabbitmq-data.sh<br />sudo
  rabbitmqctl stop_app<br />sudo
  rabbitmqctl reset<br />sudo
  rabbitmqctl start_app<br />sudo
  rabbitmqctl cluster_status | optional, 视需要. 第一个节点不宜 |

 <br />**Peer Discovery Using Consul**<br />[https://www.rabbitmq.com/cluster-formation.html#peer-discovery-consul](https://www.rabbitmq.com/cluster-formation.html#peer-discovery-consul)<br />[https://github.com/rabbitmq/rabbitmq-peer-discovery-consul](https://github.com/rabbitmq/rabbitmq-peer-discovery-consul)

| ##enable-rabbimq-consul-discovery.sh<br />sudo rabbitmq-plugins
  enable --offline rabbitmq_peer_discovery_consul<br />cat
  <<EOF | sudo tee --append  /etc/rabbitmq/rabbitmq.conf<br />cluster_formation.peer_discovery_backend
  = rabbit_peer_discovery_consul<br />#
  accordingly<br />cluster_formation.consul.host
  = dev.ufotosoft.com<br /># 8500 is
  used by default<br />cluster_formation.consul.port
  = 8500<br /># http is
  used by default<br />cluster_formation.consul.scheme
  = http<br />cluster_formation.consul.svc
  = rabbitmq<br />cluster_formation.consul.svc_addr_auto
  = true<br />cluster_formation.consul.svc_addr_use_nodename
  = true<br />cluster_formation.consul.use_longname
  = true<br /># health
  check interval (node TTL) in seconds, default: 30<br />cluster_formation.consul.svc_ttl
  = 30<br /># in
  seconds,  must not be lower than 60 that is a Consul
  requirement)<br />cluster_formation.consul.deregister_after
  = 90<br /># lock
  acquisition timeout in seconds, default: 300<br />cluster_formation.consul.lock_timeout
  = 300<br />EOF<br /> <br />sudo
  service rabbitmq-server restart<br />sudo
  rabbitmq-diagnostics node_health_check<br />sudo
  rabbitmqctl cluster_status<br />  |   |
| --- | --- |
| ##clear-rabbitmq-data.sh<br />sudo
  rabbitmqctl stop_app<br />sudo
  rabbitmqctl reset<br />sudo
  rabbitmqctl start_app<br />sudo
  rabbitmqctl cluster_status | optional, 视需要. 第一个节点不宜 |
| # on the consul server
  curl [http://127.0.0.1:8500/v1/agent/services](http://127.0.0.1:8500/v1/agent/services)<br />curl [http://localhost:8500/v1/catalog/service/rabbitmq](http://localhost:8500/v1/catalog/service/rabbitmq) | 验证on a consul
  server |

 <br />**clear data**<br />clear-rabbitmq-data.sh

| # unify the
  cookie<br />sudo echo
  "IBRKABSEAWMHOBQXZXKO" |sudo tee /var/lib/rabbitmq/.erlang.cookie<br />
  sudo rabbitmqctl stop_app<br />sudo
  rabbitmqctl reset<br />sudo
  rabbitmqctl start_app<br />sudo
  rabbitmqctl cluster_status<br /> <br />sudo
  systemctl stop rabbitmq-server.service<br />sudo rm /var/lib/rabbitmq/.erlang.cookie<br />sudo
  systemctl start rabbitmq-server.service<br /> <br /># add web
  users<br />sudo
  rabbitmqctl add_user admin admin123<br />sudo
  rabbitmqctl set_permissions -p / admin ".*" ".*"
  ".*"<br />sudo
  rabbitmqctl set_user_tags admin administrator<br />  | 注: sudo rabbitmqctl reset不会清除cookie. 需要手动统一cookie, 查看已有server的cookie: sudo
  less /var/lib/rabbitmq/.erlang.cookie |
| --- | --- |

 <br />**setup**<br />ubuntu: 推荐使用指定apt repo安装 <br />[http://www.rabbitmq.com/install-debian.html](http://www.rabbitmq.com/install-debian.html)<br />[http://www.rabbitmq.com/download.html](http://www.rabbitmq.com/download.html)
<br />Controlling System Limits on Linux:<br />[http://www.rabbitmq.com/install-debian.html#kernel-resource-limits](http://www.rabbitmq.com/install-debian.html#kernel-resource-limits)<br />注: 将注册为了服务, 且自启, 使用的为service命令. 管理也需service命令

| lsb_release  -a | 得: <br />No LSB
  modules are available.<br />Distributor
  ID: Ubuntu<br />Description:    Ubuntu 16.04.5 LTS<br />Release:        16.04<br />Codename:       xenial |
| --- | --- |
| ##install-rabbitmq.sh<br />#https准备<br />sudo
  apt-get install -y apt-transport-https<br /> <br />#signing
  key准备<br />sudo
  apt-key adv --keyserver "hkps.pool.sks-keyservers.net" --recv-keys
  "0x6B73A36E6026DFCA"<br /> <br />#rebo 指定<br />sudo echo
  "deb [https://dl.bintray.com/rabbitmq/debian](https://dl.bintray.com/rabbitmq/debian)
  xenial erlang" | sudo  tee  /etc/apt/sources.list.d/bintray.erlang.list<br /> <br />sudo echo
  "deb [https://dl.bintray.com/rabbitmq/debian](https://dl.bintray.com/rabbitmq/debian)
  xenial main" | sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list<br /> <br />sudo
  apt-get update<br /> <br /> <br />#install
  erlang<br />sudo
  apt-get -y install erlang<br /> <br />#install
  rabbitmq, 自动注册服务并开启自启<br />sudo
  apt-get -y install rabbitmq-server<br /> <br /># 仅限开发环境. 配置允许非localhost访问<br /># sudo echo
  "loopback_users = none" | sudo tee /etc/rabbitmq/rabbitmq.conf<br /># sudo
  service rabbitmq-server restart<br /> <br /># add an
  admin web user<br />sudo
  rabbitmqctl add_user admin weiw8292<br />sudo
  rabbitmqctl set_permissions -p / admin ".*" ".*"
  ".*"<br />sudo
  rabbitmqctl set_user_tags admin administrator<br /> <br /># 开启admin web<br />sudo
  rabbitmq-plugins enable rabbitmq_management<br /> <br /># setup
  rabbitmqadmin<br />wget [http://localhost:15672/cli/rabbitmqadmin](http://localhost:15672/cli/rabbitmqadmin)<br />sudo mv
  rabbitmqadmin /usr/local/bin<br />sudo chown
  root:root /usr/local/bin/rabbitmqadmin<br />sudo chmod
  775 /usr/local/bin/rabbitmqadmin<br />ls -l
  /usr/local/bin/rabbitmqadmin<br />rabbitmqadmin
  --help<br />sudo sh -c
  'rabbitmqadmin --bash-completion > /etc/bash_completion.d/rabbitmqadmin'<br />sudo
  service rabbitmq-server status<br />sudo
  rabbitmqctl status<br />sudo
  rabbitmq-diagnostics is_running | install and config  |
| sudo
  service rabbitmq-server status<br />[http://localhost:15672](http://localhost:15672)   guest / guest<br />sudo
  rabbitmq-diagnostics node_health_check<br />sudo rabbitmqctl
  status<br />ls /var/log/rabbitmq | 验证 |

 <br />**端口**<br />·       
4369: [epmd](http://erlang.org/doc/man/epmd.html), a peer discovery
service used by RabbitMQ nodes and CLI tools<br />·       
5672, 5671: used by AMQP 0-9-1 and 1.0
clients without and with TLS<br />·       
25672: used for inter-node and CLI tools
communication (Erlang distribution server port) and is allocated from a dynamic
range (limited to a single port by default, computed as AMQP port + 20000).
Unless external connections on these ports are really necessary (e.g. the
cluster uses [federation](https://www.rabbitmq.com/federation.html) or CLI tools are
used on machines outside the subnet), these ports should not be publicly
exposed. See [networking guide](https://www.rabbitmq.com/networking.html) for details.<br />·       
35672-35682: used by CLI tools (Erlang
distribution client ports) for communication with nodes and is allocated from a
dynamic range (computed as server distribution port + 10000 through server
distribution port + 10010). See [networking guide](https://www.rabbitmq.com/networking.html) for details.<br />·       
15672: [HTTP API](https://www.rabbitmq.com/management.html) clients, [management UI](https://www.rabbitmq.com/management.html) and [rabbitmqadmin](https://www.rabbitmq.com/management-cli.html) (only if the [management plugin](https://www.rabbitmq.com/management.html)is enabled)<br />·       
61613, 61614: [STOMP clients](https://stomp.github.io/stomp-specification-1.2.html) without and with
TLS (only if the [STOMP plugin](https://www.rabbitmq.com/stomp.html) is enabled)<br />·       
1883, 8883: ([MQTT
clients](http://mqtt.org/) without and with TLS, if the [MQTT plugin](https://www.rabbitmq.com/mqtt.html) is enabled<br />·       
15674: STOMP-over-WebSockets clients (only
if the [Web STOMP plugin](https://www.rabbitmq.com/web-stomp.html) is enabled)<br />·       
15675: MQTT-over-WebSockets clients (only
if the [Web MQTT plugin](https://www.rabbitmq.com/web-mqtt.html) is enabled)<br /> <br />** **<br />**排错手段**

| journalctl
  -u rabbitmq | less | 服务启动日志 |
| --- | --- |
| ls /var/log/rabbitmq | 运行日志 |
| sudo rabbitmqctl
  status | 查看状态 |
| sudo
  service rabbitmq-server status | 或 systemctl status
  rabbitmq-server.service |

 <br />**Not management user**<br />背景: 登录admin web时

| rabbitmqctl
  add_user admin admin <br />rabbitmqctl
  set_permissions -p / admin ".*" ".*" ".*"<br />rabbitmqctl
  set_user_tags admin administrator |   |
| --- | --- |

 <br />**加群总不成功**<br />统一cookie, 然后reset data

| sudo systemctl stop rabbitmq-server.service<br />sudo echo
  "IBRKABSEAWMHOBQXZXKO" |sudo tee /var/lib/rabbitmq/.erlang.cookie<br />sudo systemctl start rabbitmq-server.service | unify cookie |
| --- | --- |
| sudo rabbitmqctl stop_app<br />sudo rabbitmqctl reset<br />sudo rabbitmqctl start_app | reset data<br />
  若sudo rabbitmqctl reset不行,<br />则sudo
  rabbitmqctl force_reset |
| sudo rabbitmq-diagnostics
  discover_peers<br />sudo rabbitmqctl cluster_status | verify |
| 汇合为一条多行命令:<br />sudo
  systemctl stop rabbitmq-server.service \<br />&&
  sudo echo "IBRKABSEAWMHOBQXZXKO" |sudo tee
  /var/lib/rabbitmq/.erlang.cookie \<br />&&
  sudo systemctl start rabbitmq-server.service \<br />&&
  sudo rabbitmqctl stop_app \<br />&&
  sudo rabbitmqctl reset \<br />&&
  sudo rabbitmqctl start_app \<br />&&
  sudo rabbitmq-diagnostics discover_peers \<br />&&
  sudo rabbitmqctl cluster_status |   |

 <br /> <br />**exchange type**<br />topic
excahnge可实现所有其他exchange的功能

| _type_ | _description_ | _route rule_ | _exchange_ | _routing key_ | _queue_ |
| --- | --- | --- | --- | --- | --- |
| Default
  Exchange | A Direct
  Exchange | equality | "",
  pre-declared | define | declare |
| Direct
  Exchange | delivers
  messages to queues based on the message routing key. 消息只存在一份 | equality | declare | define | declare |
| Fanout
  Exchange | routes
  messages to all of the queues that are bound to it and the routing key is
  ignored | ignore
  routing key, fanout | declare | ignored  | declare |
| Topic
  Exchange | routes
  messages to one or many queues based on matching between a message routing key
  and the pattern that was used to bind a queue to an exchange | match:<br />* (star)
  can substitute for exactly one word.<br /># (hash)
  can substitute for zero or more words. | declare | define | declare |
| Headers
  Exchange | A headers
  exchange is designed for routing on multiple attributes that are more easily
  expressed as message headers than a routing key |   |   |   |   |

 <br />**windows**

| app data
  dir | C:\Users\luobd\AppData\Roaming\RabbitMQ |
| --- | --- |
| config dir | C:\Users\luobd\AppData\Roaming\RabbitMQ\config |
| log dir | C:\Users\luobd\AppData\Roaming\RabbitMQ\log |
| db dir | C:\Users\luobd\AppData\Roaming\RabbitMQ\db |
| software
  home | C:\Program
  Files\RabbitMQ Server |
| specific
  version home | C:\Program Files\RabbitMQ
  Server\rabbitmq_server-3.7.4 |
| bin dir | C:\Program
  Files\RabbitMQ Server\rabbitmq_server-3.7.4\sbin |

 <br />**consumer acknowledgement spring **<br />[https://stackoverflow.com/questions/38728668/spring-rabbitmq-using-manual-channel-acknowledgement-on-a-service-with-rabbit/38730821](https://stackoverflow.com/questions/38728668/spring-rabbitmq-using-manual-channel-acknowledgement-on-a-service-with-rabbit/38730821)

|    
  @RabbitListener(queues = "Q-xx")<br />        public void receive(String payload,
  Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag)<br />                throws IOException {<br />            System.out.println(payload);<br />            channel.basicAck(tag, false);<br />        }<br />
  spring:<br /> 
  rabbitmq:<br />   
  listener:<br />      type: simple<br />      simple:<br />        acknowledge-mode: manual |   |
| --- | --- |

** **<br />**测试**<br />AWS
ELB下, 不断创建queue

| 条件 | 结果 |
| --- | --- |
| no mirror<br />
  "queue-master-locator":"client-local"  # default
    | 总创建在相同的node上 |
| sudo rabbitmqctl set_policy
  test-master-locator-min-masters ".*" '{      
  "queue-master-locator":"min-masters"   }' | 按min-masters选择node, 均衡在node上 |
| sudo
  rabbitmqctl set_policy test-two-replica ".*"   '{ 
  "queue-master-locator":"min-masters", "ha-mode":"exactly",
  "ha-params":2 }'<br />
    | 按配置表现 |

结论: java client与server为长连接, ELB不改变此性质<br /> <br />**spring amqp reference<br />[https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference](https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference)<br />可以使用adrresses属性来配置多个host:<br /><rabbit:connection-factory<br />    id="connectionFactory"
addresses="host1:5672,host2:5672"/><br /> <br />The
use of separate connections might be useful in some environments, such as
consuming from an HA cluster, in conjunction with a load balancer, to connect
to different cluster members, and others. To cache connections, set the cacheMode
to CacheMode.CONNECTION<br /> <br />org.springframework.amqp.rabbit.core.RabbitTemplate.setUsePublisherConnection(boolean
usePublisherConnection)<br /> <br />Automatic Connection/Topology recovery<br />the RabbitAdmin re-declares any infrastructure beans
(queues and others) when the connection is re-established.<br />Only elements (queues, exchanges, bindings) that are
defined as beans will be re-declared after a connection failure.<br /> <br />message
converter:<br />org.springframework.amqp.support.converter.Jackson2JsonMessageConverter<br /> <br />connection
factory:<br />org.springframework.amqp.rabbit.connection.LocalizedQueueConnectionFactory<br /> <br /> <br />使用separate
connection:<br />[https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference/#separate-connection](https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference/#separate-connection)<br />对RabbitmqTemplate,
set the usePublisherConnection property to true<br />但需要构造RabbitAdmin时使用RabbitAdmin(ConnectionFactory connectionFactory)<br /> <br /> <br />避免使用事务<br /> <br />ConnectionListener可作监控:<br />this.connectionFactory.addConnectionListener(new
ConnectionListener() {<br /> <br />    @Override<br />    public void onCreate(Connection connection)
{<br />    }<br /> <br />    @Override<br />    public void
onShutDown(ShutdownSignalException signal) {<br />        ...<br />    }<br /> <br />});<br /> <br />看到:<br />[https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference/#amqp-template](https://docs.spring.io/spring-amqp/docs/2.1.4.RELEASE/reference/#amqp-template)
<br /> <br />**问题解决<br />**Channel shutdown: connection error**<br />2019-02-27 21:01:22.098 ERROR 21608 --- [08.183.218:5672]
c.r.c.impl.ForgivingExceptionHandler    
: An unexpected connection driver error occured<br />com.rabbitmq.client.MissedHeartbeatException:
Heartbeat missing with heartbeat = 1 seconds<br />at
com.rabbitmq.client.impl.AMQConnection.handleSocketTimeout(AMQConnection.java:778)
~[amqp-client-5.4.3.jar:5.4.3]<br />at
com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:678)
~[amqp-client-5.4.3.jar:5.4.3]<br />at
com.rabbitmq.client.impl.AMQConnection.access$300(AMQConnection.java:48)
~[amqp-client-5.4.3.jar:5.4.3]<br />at
com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:597)
~[amqp-client-5.4.3.jar:5.4.3]<br />at
java.lang.Thread.run(Thread.java:748) [na:1.8.0_191]<br />2019-02-27
21:01:22.099 ERROR 21608 --- [08.183.218:5672]
o.s.a.r.c.CachingConnectionFactory      
: Channel shutdown: connection error<br />背景: rabbitmq 使用LB报的错, 与connection
mode是channel或connection无关:<br />尝试解决:<br />减小client的心跳检测时间

| spring.rabbitmq.requested-heartbeat=5s | 实为为heartbeat
  timeout, 建议: 5s-20s |
| --- | --- |

资料:<br />spring boot rabbitmq默认heartbeat interval为60s<br />[https://stackoverflow.com/questions/29055529/channel-shutdown-connection-error](https://stackoverflow.com/questions/29055529/channel-shutdown-connection-error)<br />[https://www.rabbitmq.com/heartbeats.html](https://www.rabbitmq.com/heartbeats.html)<br />[https://www.rabbitmq.com/heartbeats.html#tcp-proxies](https://www.rabbitmq.com/heartbeats.html#tcp-proxies)<br />[https://www.rabbitmq.com/troubleshooting-networking.html](https://www.rabbitmq.com/troubleshooting-networking.html)<br />heartbeat timeout不同于heartbeat interval

| heartbeat interval
  = heartbeat timeout / 2 |   |
| --- | --- |

下面都对heartbeat timeout而言:<br />rabbitmq server 默认heartbeat timeout为60s  (则60/2=30s为heartbeat  interval)<br />rabbitmq官文建议heartbeat timeout 5 to 20
seconds ,则heartbeat interval为2s-10s<br />sprint boot rabbitmq中提供的为heartbeat timeout<br />其他资料: use TCP keepalive packets to
reset the idle timeout<br />network ELB的iddle connection timeout写死为350s, 无法改.But Your targets can use TCP
keepalive packets to reset the idle timeout<br />[https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout)     <br /> 

